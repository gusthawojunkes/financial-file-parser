<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial File Parser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .card {
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            height: 100%;
        }
        .file-drop-zone {
            border: 2px dashed #d9d9d9;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
        }
        .file-drop-zone:hover {
            background-color: #f7f7f7;
        }
        .file-drop-zone p {
            margin: 0;
        }
        .file-drop-zone .icon {
            font-size: 48px;
            color: #d9d9d9;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-primary {
            width: 100%;
        }
        .code-block {
            position: relative;
            margin-top: 1rem;
            height: 100%;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1;
        }
        .copy-btn:hover {
            background-color: #5a6268;
        }
        .hljs {
            border-radius: 8px;
            height: 100%;
        }
        .ts-control .item img, .ts-dropdown .option img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-5">
        <div class="row justify-content-center">
            <div id="form-container" class="col-12 col-lg-6">
                <div class="card shadow-sm">
                    <form id="uploadForm">
                        <div>
                            <h5>1. Envie o seu arquivo</h5>
                            <div class="file-drop-zone mt-3" id="fileDropZone">
                                <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
                                <p>Clique para enviar ou arraste e solte</p>
                                <p class="text-muted">OFX, PDF, CSV</p>
                                <input type="file" id="file" class="d-none">
                            </div>
                            <div id="fileName" class="mt-2 text-center"></div>
                        </div>

                        <div class="mt-4">
                            <h5>2. Configure os parâmetros</h5>
                            <div class="mb-3">
                                <label for="institution" class="form-label">Instituição</label>
                                <select id="institution" name="institution" required></select>
                            </div>
                            <div class="mb-3">
                                <label for="fileExtension" class="form-label">Extensão do arquivo</label>
                                <select class="form-select" id="fileExtension" name="fileExtension" required>
                                    <option value="OFX">OFX</option>
                                    <option value="CSV">CSV</option>
                                    <option value="PDF">PDF (Não suportado)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="invoiceType" class="form-label">Tipo do arquivo</label>
                                <select class="form-select" id="invoiceType" name="invoiceType" required>
                                    <option value="CREDIT_INVOICE">Fatura de cartão de crédito</option>
                                    <option value="ACCOUNT_STATEMENT">Extrato da conta</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Processar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="result-container" class="col-12 col-lg-6 d-none">
                <div id="result" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script>
        function copyToClipboard(button) {
            const pre = button.parentElement.querySelector('pre');
            const textToCopy = pre.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                button.innerText = 'Copiado!';
                setTimeout(() => {
                    button.innerText = 'Copiar';
                }, 2000);
            }).catch(err => {
                console.error('Erro ao copiar: ', err);
                alert('Erro ao copiar para a área de transferência.');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            new TomSelect('#institution',{
                valueField: 'value',
                labelField: 'text',
                searchField: 'text',
                options: [
                    {value: 'NUBANK', text: 'Nubank', icon: 'icons/nubank-logo-2021.svg'},
                    {value: 'ITAU', text: 'Itaú', icon: 'icons/itau-logo-2023.svg'},
                    {value: 'C6', text: 'C6', icon: 'icons/c6-bank-logo-mini.jpeg'},
                    {value: 'CAIXA', text: 'Caixa', icon: 'icons/caixa-logo-2023.svg'},
                    {value: 'BRADESCO', text: 'Bradesco', icon: 'icons/bradesco-logo.png'},
                    {value: 'WISE', text: 'Wise', icon: 'icons/wise-logo-mini.png'}
                ],
                items: ['NUBANK'],
                render: {
                    option: function(data, escape) {
                        return '<div><img src="' + data.icon + '" class="me-2" style="width: 40px; height: 40px;" />' + escape(data.text) + '</div>';
                    },
                    item: function(data, escape) {
                        return '<div><img src="' + data.icon + '" class="me-2" style="width: 40px; height: 40px;" />' + escape(data.text) + '</div>';
                    }
                }
            });

            const uploadForm = document.getElementById('uploadForm');
            const resultDiv = document.getElementById('result');
            const fileDropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('file');
            const fileNameDiv = document.getElementById('fileName');
            const resultContainer = document.getElementById('result-container');
            const mainRow = document.querySelector('.row');

            if(fileDropZone) {
                fileDropZone.addEventListener('click', () => fileInput.click());

                fileDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.add('bg-light');
                });

                fileDropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.remove('bg-light');
                });

                fileDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.remove('bg-light');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        if (fileNameDiv) {
                            fileNameDiv.textContent = `Arquivo selecionado: ${files[0].name}`;
                        }
                    }
                });
            }
            
            if(fileInput) {
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0) {
                        if (fileNameDiv) {
                            fileNameDiv.textContent = `Arquivo selecionado: ${fileInput.files[0].name}`;
                        }
                    }
                });
            }

            if(uploadForm) {
                uploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const file = fileInput.files[0];
                    if (!file) {
                        alert("Por favor, selecione um arquivo.");
                        return;
                    }
                    
                    const institution = document.getElementById('institution').value;
                    const fileExtension = document.getElementById('fileExtension').value;
                    const invoiceType = document.getElementById('invoiceType').value;

                    const url = '/api/v1/file/process';

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            body: file,
                            headers: {
                                'Content-Type': 'application/octet-stream',
                                'Institution': institution,
                                'File-Type': fileExtension,
                                'Invoice-Type': invoiceType
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const jsonResult = JSON.stringify(result, null, 2);
                            const itemCount = result.length;
                            
                            mainRow.classList.remove('justify-content-center');
                            resultContainer.classList.remove('d-none');

                            resultDiv.innerHTML = `
                                <div class="card shadow-sm">
                                    <h3>Resultado do processamento</h3>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <p class="mb-0"><strong>${itemCount}</strong> transações encontradas</p>
                                    </div>
                                    <div class="code-block">
                                        <button class="copy-btn" onclick="copyToClipboard(this)">Copiar</button>
                                        <pre><code class="language-json">${jsonResult}</code></pre>
                                    </div>
                                </div>
                            `;
                            hljs.highlightElement(resultDiv.querySelector('code'));
                        } else {
                            const errorText = await response.text();
                            resultContainer.classList.remove('d-none');
                            resultDiv.innerHTML = `
                                <div class="card shadow-sm">
                                    <h3>Erro</h3>
                                    <div class="alert alert-danger" role="alert">
                                        <h4 class="alert-heading">${response.status} ${response.statusText}</h4>
                                        <p>${errorText}</p>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        resultContainer.classList.remove('d-none');
                        resultDiv.innerHTML = `
                            <div class="card shadow-sm">
                                <h3>Erro</h3>
                                <div class="alert alert-danger" role="alert">
                                    <p>${error.message}</p>
                                </div>
                            </div>
                        `;
                    }
                });
            }
        });
    </script>
</body>
</html>
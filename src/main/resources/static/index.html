<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial File Parser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .card {
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            height: 100%;
        }
        .file-drop-zone {
            border: 2px dashed #d9d9d9;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
        }
        .file-drop-zone:hover {
            background-color: #f7f7f7;
        }
        .file-drop-zone p {
            margin: 0;
        }
        .file-drop-zone .icon {
            font-size: 48px;
            color: #d9d9d9;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-primary {
            width: 100%;
        }
        .code-block {
            position: relative;
            margin-top: 1rem;
            height: 100%;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1;
        }
        .copy-btn:hover {
            background-color: #5a6268;
        }
        .hljs {
            border-radius: 8px;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-5">
        <div class="row">
            <div id="form-container" class="col-12 d-flex justify-content-center">
                <div style="width: 600px;">
                    <div class="card shadow-sm">
                        <form id="uploadForm">
                            <div>
                                <h5>1. Envie o seu arquivo</h5>
                                <div class="file-drop-zone mt-3" id="fileDropZone">
                                    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
                                    <p>Clique para enviar ou arraste e solte</p>
                                    <p class="text-muted">OFX, PDF, CSV</p>
                                    <input type="file" id="file" class="d-none">
                                </div>
                                <div id="fileName" class="mt-2 text-center"></div>
                            </div>
    
                            <div class="mt-4">
                                <h5>2. Configure os parâmetros</h5>
                                <div class="mb-3">
                                    <label for="institution" class="form-label">Instituição</label>
                                    <select class="form-select" id="institution" name="institution" required>
                                        <option value="NUBANK">
                                            <span>
                                                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 22C6.486 22 2 17.514 2 12S6.486 2 12 2s10 4.486 10 10-4.486 10-10 10zm-1.2-6.4h-2.4v-7.2h2.4v7.2zm4.8 0h-2.4v-7.2h2.4v7.2z" fill="#8A05BE"/>
                                                </svg>
                                            </span>
                                            Nubank
                                        </option>
                                        <option value="C6">C6</option>
                                        <option value="BRADESCO">Bradesco</option>
                                        <option value="WISE">Wise</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="fileExtension" class="form-label">Extensão do arquivo</label>
                                    <select class="form-select" id="fileExtension" name="fileExtension" required>
                                        <option value="OFX">OFX</option>
                                        <option value="CSV">CSV</option>
                                        <option value="PDF">PDF (Não suportado)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="invoiceType" class="form-label">Tipo do arquivo</label>
                                    <select class="form-select" id="invoiceType" name="invoiceType" required>
                                        <option value="CREDIT_INVOICE">Fatura de cartão de crédito</option>
                                        <option value="ACCOUNT_STATEMENT">Extrato da conta</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Processar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="result-container" class="col-6 d-none">
                <div id="result" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        function copyToClipboard(button) {
            const pre = button.parentElement.querySelector('pre');
            const textToCopy = pre.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                button.innerText = 'Copiado!';
                setTimeout(() => {
                    button.innerText = 'Copiar';
                }, 2000);
            }).catch(err => {
                console.error('Erro ao copiar: ', err);
                alert('Erro ao copiar para a área de transferência.');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const uploadForm = document.getElementById('uploadForm');
            const resultDiv = document.getElementById('result');
            const fileDropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('file');
            const fileNameDiv = document.getElementById('fileName');
            const formContainer = document.getElementById('form-container');
            const resultContainer = document.getElementById('result-container');

            if(fileDropZone) {
                fileDropZone.addEventListener('click', () => fileInput.click());

                fileDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.add('bg-light');
                });

                fileDropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.remove('bg-light');
                });

                fileDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.remove('bg-light');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        if (fileNameDiv) {
                            fileNameDiv.textContent = `Arquivo selecionado: ${files[0].name}`;
                        }
                    }
                });
            }
            
            if(fileInput) {
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0) {
                        if (fileNameDiv) {
                            fileNameDiv.textContent = `Arquivo selecionado: ${fileInput.files[0].name}`;
                        }
                    }
                });
            }

            if(uploadForm) {
                uploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const file = fileInput.files[0];
                    if (!file) {
                        alert("Por favor, selecione um arquivo.");
                        return;
                    }
                    
                    const institution = document.getElementById('institution').value;
                    const fileExtension = document.getElementById('fileExtension').value;
                    const invoiceType = document.getElementById('invoiceType').value;

                    const url = '/api/v1/file/process';

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            body: file,
                            headers: {
                                'Content-Type': 'application/octet-stream',
                                'Institution': institution,
                                'File-Type': fileExtension,
                                'Invoice-Type': invoiceType
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const jsonResult = JSON.stringify(result, null, 2);
                            const itemCount = result.length;
                            
                            formContainer.classList.remove('col-12', 'd-flex', 'justify-content-center');
                            formContainer.classList.add('col-6');
                            resultContainer.classList.remove('d-none');
                            resultContainer.classList.add('col-6');

                            resultDiv.innerHTML = `
                                <h3>Resultado do processamento</h3>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <p class="mb-0"><strong>${itemCount}</strong> transações encontradas</p>
                                </div>
                                <div class="code-block">
                                    <button class="copy-btn" onclick="copyToClipboard(this)">Copiar</button>
                                    <pre><code class="language-json">${jsonResult}</code></pre>
                                </div>
                            `;
                            hljs.highlightElement(resultDiv.querySelector('code'));
                        } else {
                            const errorText = await response.text();
                            resultDiv.innerHTML = `
                                <h3>Erro</h3>
                                <div class="alert alert-danger" role="alert">
                                    <h4 class="alert-heading">${response.status} ${response.statusText}</h4>
                                    <p>${errorText}</p>
                                </div>
                            `;
                        }
                    } catch (error) {
                        resultDiv.innerHTML = `
                            <h3>Erro</h3>
                            <div class="alert alert-danger" role="alert">
                                <p>${error.message}</p>
                            </div>
                        `;
                    }
                });
            }
        });
    </script>
</body>
</html>